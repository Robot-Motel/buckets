%%{init: {'themeVariables': {'subgraphTitleTextAlign': 'left'}}}%%
flowchart TD
    subgraph check repo
        A[Commit command] --> Z{Check if valid \n buckets repository}
        Z --> |Yes| B[Read repository config file]
        Z --> |No| E1[Error: Not a valid buckets repository]
        end

        subgraph bucket check
        B --> C[Find top level bucket directory]
        C --> D{Check if valid \n bucket directory}
        D -->|Yes| V[Read bucket config from file]
        D -->|No| E2[Error: Not a valid bucket directory]
    end

    subgraph BucketCommand
        V --> H
        H[Generate meta data list: blake3 hash and filename] --> I{Any files in list?}
        I -->|Yes| J[Load previous commit meta data]
        J --> K{Files in \n previous commit?}
        K -->|Yes| L[Compare commits]
        K -->|No| M[Insert commit into database]
        L --> N{Changes?}
        N -->|Yes| M



        subgraph Loop[all files in commit]
            Q[Insert file meta data into database] --> R[Compress and store file]
        end

        M --> Loop
    end
    R --> P((End))
    I -->|No| P((End))
    N -->|No| P((End))
    E1-->|No| P((End))
    E2 -->|No| P((End))

    style E1 fill:#f57474
    style E2 fill:#f57474